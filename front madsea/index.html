<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryFlow AI - Transform Storyboards into Animated Sequences</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .scene-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .scene-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- Sidebar -->
    <div class="sidebar w-64 bg-white shadow-lg flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center text-white">
                    <i class="fas fa-film text-xl"></i>
                </div>
                <h1 class="text-xl font-semibold text-gray-800">StoryFlow AI</h1>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <nav class="p-4">
                <div class="space-y-1">
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 bg-indigo-50 text-indigo-700 rounded-lg font-medium">
                        <i class="fas fa-home text-indigo-600"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">
                        <i class="fas fa-project-diagram"></i>
                        <span>Projects</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">
                        <i class="fas fa-palette"></i>
                        <span>Styles Library</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Tutorials</span>
                    </a>
                </div>
                
                <div class="mt-8">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Recent Projects</h3>
                    <div class="space-y-1">
                        <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="truncate">Sci-Fi Short Film</span>
                        </a>
                        <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                            <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                            <span class="truncate">Fantasy Adventure</span>
                        </a>
                        <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                            <div class="w-2 h-2 rounded-full bg-gray-500"></div>
                            <span class="truncate">Documentary</span>
                        </a>
                    </div>
                </div>
            </nav>
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center">
                    <i class="fas fa-user text-gray-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-800">John Director</p>
                    <p class="text-xs text-gray-500">Pro Plan</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Navigation -->
        <header class="bg-white shadow-sm">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button class="text-gray-500 focus:outline-none lg:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">Current Project: Sci-Fi Short Film</h2>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="text-gray-500 focus:outline-none">
                            <i class="fas fa-bell"></i>
                        </button>
                        <span class="absolute top-0 right-0 w-2 h-2 rounded-full bg-red-500"></span>
                    </div>
                    <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-play mr-2"></i> Generate Video
                    </button>
                </div>
            </div>
            
            <div class="border-t border-gray-200">
                <div class="px-6">
                    <nav class="flex space-x-8">
                        <a href="#" class="border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Storyboard</a>
                        <a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Generated Scenes</a>
                        <a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Animation</a>
                        <a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Export</a>
                        <a href="#" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Settings</a>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                <!-- Conteneur pour la gestion des projets -->
                <div id="projects-container"></div>
                <!-- Project Overview -->
                <div id="scenes-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Project Progress</h3>
                            <span class="text-sm text-indigo-600 font-medium">65%</span>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 65%"></div>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Scenes</p>
                                <p class="text-lg font-semibold">12/18</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Generated</p>
                                <p class="text-lg font-semibold">8</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Animated</p>
                                <p class="text-lg font-semibold">4</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-medium text-gray-900">Current Style</h3>
                        <div class="mt-4 flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-lg overflow-hidden">
                                <img src="https://images.unsplash.com/photo-1518709268805-453e5230c1b0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h4 class="font-medium">Cinematic Silhouette</h4>
                                <p class="text-sm text-gray-500">Déclic Style</p>
                                <button class="mt-1 text-xs text-indigo-600 hover:text-indigo-800">Change Style</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-medium text-gray-900">Generation Settings</h3>
                        <div class="mt-4 space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">AI Engine</span>
                                <span class="text-sm font-medium">Stable Diffusion XL</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">Processing Mode</span>
                                <span class="text-sm font-medium">Local (GPU)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">ControlNet</span>
                                <span class="text-sm font-medium">Scribble</span>
                            </div>
                            <button class="mt-2 w-full text-xs text-indigo-600 hover:text-indigo-800 text-left">Advanced Settings</button>
                        </div>
                    </div>
                </div>
                
                <!-- Action Bar -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-3">
                            <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                                <i class="fas fa-plus mr-2"></i> Add Scene
                            </button>
                            <button id="import-pdf-btn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center" disabled>
                                <i class="fas fa-upload mr-2"></i> Import PDF
                            </button>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <input type="text" placeholder="Search scenes..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Scenes Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="scenes-grid">
                    <!-- Les cartes de scènes extraites s’affichent ici dynamiquement via JS -->
                    
                    <!-- Scene Card - Example 2 -->
                    <div class="scene-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md">
                        <div class="relative aspect-video bg-gray-100">
                            <img src="https://images.unsplash.com/photo-1457364887196-7023db5ddbed?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover">
                            <div class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">Scene 2</div>
                            <div class="absolute bottom-2 right-2 bg-white text-indigo-600 text-xs px-2 py-1 rounded-full shadow">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-medium text-gray-900">Cockpit Interior</h3>
                            <p class="text-sm text-gray-500 mt-1">Int. Spaceship - Close-up on pilot's face as alarm sounds</p>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">Generated</span>
                                <div class="flex space-x-2">
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scene Card - Example 3 -->
                    <div class="scene-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md">
                        <div class="relative aspect-video bg-gray-100">
                            <img src="https://images.unsplash.com/photo-1454789548928-9a5b1a0e8d1f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover">
                            <div class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">Scene 3</div>
                            <div class="absolute bottom-2 right-2 bg-white text-yellow-500 text-xs px-2 py-1 rounded-full shadow">
                                <i class="fas fa-spinner animate-spin"></i>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-medium text-gray-900">Alien Planet Surface</h3>
                            <p class="text-sm text-gray-500 mt-1">Ext. Planet - Medium shot of crew stepping onto surface</p>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-600 rounded">Generating...</span>
                                <div class="flex space-x-2">
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scene Card - Example 4 (Storyboard only) -->
                    <div class="scene-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md">
                        <div class="relative aspect-video bg-gray-100 flex items-center justify-center">
                            <div class="text-center p-4">
                                <i class="fas fa-image text-4xl text-gray-300 mb-2"></i>
                                <p class="text-sm text-gray-500">Storyboard only</p>
                            </div>
                            <div class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">Scene 4</div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-medium text-gray-900">First Contact</h3>
                            <p class="text-sm text-gray-500 mt-1">Ext. Ruins - Alien creature emerges from shadows</p>
                            <div class="mt-3 flex items-center justify-between">
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">Not Generated</span>
                                <div class="flex space-x-2">
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-magic"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-gray-400 hover:text-indigo-600">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Scene Card -->
                    <div class="scene-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md border-2 border-dashed border-gray-300 hover:border-indigo-300 flex items-center justify-center">
                        <button class="text-center p-6 w-full">
                            <div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-plus text-xl"></i>
                            </div>
                            <h3 class="font-medium text-gray-900">Add New Scene</h3>
                            <p class="text-sm text-gray-500 mt-1">Upload image or start from scratch</p>
                        </button>
                    </div>
                </div>
                
                <!-- Generation Panel (Example) -->
                <div class="mt-8 bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                        <h3 class="text-lg font-medium text-gray-900">Scene Generation Progress</h3>
                        <button class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center space-x-4 mb-6">
                            <div class="relative">
                                <svg class="w-16 h-16" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#e5e7eb" stroke-width="2"></circle>
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="#4f46e5" stroke-width="2" stroke-dasharray="80 100" stroke-linecap="round"></circle>
                                </svg>
                                <span class="absolute inset-0 flex items-center justify-center text-sm font-medium">80%</span>
                            </div>
                            <div>
                                <h4 class="font-medium">Generating Scene 3: Alien Planet Surface</h4>
                                <p class="text-sm text-gray-500 mt-1">Applying cinematic silhouette style...</p>
                                <div class="mt-2 w-full bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-indigo-600 h-1.5 rounded-full" style="width: 80%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div class="border rounded-lg p-3">
                                <p class="text-xs text-gray-500">Original</p>
                                <div class="aspect-video bg-gray-100 mt-1 flex items-center justify-center">
                                    <i class="fas fa-image text-gray-300"></i>
                                </div>
                            </div>
                            <div class="border rounded-lg p-3">
                                <p class="text-xs text-gray-500">Current Output</p>
                                <div class="aspect-video bg-gray-100 mt-1 flex items-center justify-center">
                                    <i class="fas fa-image text-gray-300"></i>
                                </div>
                            </div>
                            <div class="border rounded-lg p-3">
                                <p class="text-xs text-gray-500">Style Reference</p>
                                <div class="aspect-video bg-gray-100 mt-1 flex items-center justify-center">
                                    <i class="fas fa-image text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                            <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                <i class="fas fa-bolt mr-2"></i> Enhance
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- JS pour la gestion des projets -->
            <script src="003-prototype-ui-projects.js"></script>
            <script>renderProjectsUI();</script>
            <!-- JS Upload PDF + extraction images (robuste, loggué, workflow séquencé) -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                // --- Sélection projet (écouteur sur création/sélection projet) ---
                let projectSelected = false;
                function checkProjectSelection() {
                    // Ici, on vérifie si un projet est sélectionné (ex: dans localStorage ou via UI)
                    // Pour la maquette, on active le bouton dès qu'il y a au moins un projet
                    try {
                        const data = JSON.parse(localStorage.getItem('madsea_projects') || '{"projects":[]}');
                        if(data.projects && data.projects.length > 0) {
                            projectSelected = true;
                        } else {
                            projectSelected = false;
                        }
                    } catch(e) { projectSelected = false; }
                    document.getElementById('import-pdf-btn').disabled = !projectSelected;
                    console.log('[Front] Project selection status:', projectSelected);
                }
                checkProjectSelection();
                window.addEventListener('storage', checkProjectSelection);
                // --- PDF Upload Handler ---
                const importPdfBtn = document.getElementById('import-pdf-btn');
                if(importPdfBtn) {
                    let fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';
                    document.body.appendChild(fileInput);
                    importPdfBtn.addEventListener('click', function() {
                        if(!projectSelected) {
                            alert('Merci de créer/sélectionner un projet avant d\'uploader un PDF.');
                            return;
                        }
                        fileInput.click();
                    });
                    fileInput.addEventListener('change', async function(e) {
                        if(!fileInput.files.length) return;
                        let formData = new FormData();
                        formData.append('storyboard_file', fileInput.files[0]);
                        importPdfBtn.disabled = true;
                        importPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Importing...';
                        console.log('[Front] Uploading PDF...');
                        try {
                            let resp = await fetch('http://localhost:5000/api/extraction_storyboard', {
                                method: 'POST',
                                body: formData
                            });
                            let data = await resp.json(); // Lire le JSON une seule fois ici
                            console.log('[Front] Backend response received. Status:', resp.status, 'Data:', data);

                            // Traitement basé sur le statut de la réponse ET le contenu
                            if (resp.ok && data && data.scenes && Array.isArray(data.scenes)) {
                                // Cas succès: JSON structuré reçu
                                console.log('[Front] Données JSON structurées reçues:', data);
                                showToast('Extraction réussie ! Affichage des scènes.', 'success');
                                window.currentProjectData = data; // Stocker les données
                                // Assurez-vous que renderScenes existe et est prête à traiter `data.scenes`
                                if(window.renderScenes) {
                                    window.renderScenes(data.scenes);
                                } else {
                                    console.error('[Front] Fonction window.renderScenes non définie.');
                                    showToast('Erreur interne: Impossible d\'afficher les scènes.', 'error');
                                }
                                checkProjectSelection(); // Réactiver les boutons si nécessaire
                            } else if (resp.ok && data && data.images && Array.isArray(data.images)) {
                                // Cas Fallback: Ancienne réponse avec seulement les images (si le statut est OK mais pas le format attendu)
                                console.warn('[Front] Format JSON structuré non reçu, fallback sur extraction images seules.');
                                const grid = document.getElementById('scenes-grid');
                                if(grid) {
                                    grid.innerHTML = ''; // Vider la grille existante
                                    data.images.forEach((imgUrl, idx) => {
                                        let fullUrl = imgUrl.startsWith('/outputs/') ? `http://localhost:5000${imgUrl}` : imgUrl;
if (!imgUrl.startsWith('/outputs/')) {
    console.warn(`[Front Fallback] URL image inattendue: ${imgUrl}. Tentative d'utilisation directe.`);
    fullUrl = imgUrl;
}
                                        let card = document.createElement('div');
                                        card.className = 'scene-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md';
                                        // ... (le reste du code de la carte reste inchangé)
                                        card.innerHTML = `
                                            <div class="relative aspect-video bg-gray-100">
                                                <img src="${fullUrl}" class="w-full h-full object-cover" onerror="this.style.opacity=0.3;showToast('Image introuvable : ${imgUrl}','error',4000);">
                                                <div class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">Scene ${idx+1}</div>
                                            </div>
                                            <div class="p-4">
                                                <h3 class="font-medium text-gray-900">Storyboard Scene ${idx+1}</h3>
                                                <p class="text-sm text-gray-500 mt-1">Image extraite du PDF (Fallback)</p>
                                                <div class="mt-3 flex items-center justify-between">
                                                    <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">Extracted</span>
                                                </div>
                                            </div>
                                        `;
                                        grid.appendChild(card);
                                    });
                                     showToast('Extraction partielle (images seules).', 'warning');
                                }
                                console.log('[Front] Fallback: Images extraites et affichées:', data.images);
                            } else {
                                // Cas Erreur: Réponse non OK ou données invalides
                                let errorMsg = data.error || `Erreur serveur (${resp.status})`;
                                alert(`Erreur lors de l'extraction: ${errorMsg}`);
                                console.error(`[Front] Erreur lors de l'extraction: ${errorMsg}`, data);
                                showToast(`Erreur: ${errorMsg}`, 'error');
                            }
                        } catch(err) {
                            // Erreur réseau ou de parsing JSON
                            alert('Erreur de communication ou format de réponse invalide: ' + err);
                            console.error('[Front] Erreur fetch ou JSON parse:', err);
                            showToast('Erreur réseau ou réponse invalide.', 'error');
                        } finally {
                            importPdfBtn.disabled = !projectSelected; // Réactiver seulement si un projet est sélectionné
                            importPdfBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> Import PDF';
                            fileInput.value = ''; // Réinitialiser l'input fichier
                        }
                    });
                }
                // Rafraîchir l’état du bouton après création projet
                window.renderProjectsUI = (function(old) {
                    return function() {
                        if(old) old();
                        checkProjectSelection();
                    }
                })(window.renderProjectsUI);
            });
            </script>
            <!-- Toast notifications -->
            <div id="toast-container" style="position:fixed;top:32px;right:32px;z-index:9999;display:flex;flex-direction:column;gap:12px;"></div>
            <script>
            function showToast(message, type = 'info', duration = 3500) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast-msg toast-${type}`;
                toast.style = `min-width:220px;max-width:340px;padding:14px 22px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);background:${type==='error'?'#fee2e2':type==='success'?'#dcfce7':'#f1f5f9'};color:${type==='error'?'#b91c1c':type==='success'?'#166534':'#334155'};font-weight:500;font-size:1rem;opacity:0;transition:opacity .3s;`;
                toast.innerText = message;
                container.appendChild(toast);
                setTimeout(()=>{toast.style.opacity=1;},10);
                setTimeout(()=>{toast.style.opacity=0;setTimeout(()=>container.removeChild(toast),300);},duration);
            }
            </script>
            
            <!-- Système d'affichage et gestion des scènes avec nomenclature production -->
            <script>
            // Fonction avancée pour l'affichage dynamique des scènes avec nomenclature production
            window.renderScenes = function(scenes) {
                console.log('[Front] Affichage des scènes avec nomenclature production');
                const grid = document.getElementById('scenes-grid');
                if (!grid) {
                    console.error('[Front] Impossible de trouver #scenes-grid');
                    showToast('Erreur interne : grille scènes introuvable.', 'error');
                    return;
                }
                
                // Référence au projet courant et extraction des métadonnées
                let projectData = {};
                try {
                    const projectSelected = localStorage.getItem('selectedProject');
                    if (projectSelected) {
                        projectData = JSON.parse(projectSelected);
                    }
                } catch(e) { 
                    console.warn('[Front] Erreur lors de la récupération des données projet:', e);
                }
                
                // Extraction des informations d'épisode/série
                const episodeCode = projectData.episodeCode || 'E000'; // Fallback si non défini
                
                // Nettoyage de la grille
                grid.innerHTML = '';
                
                if (!Array.isArray(scenes) || scenes.length === 0) {
                    grid.innerHTML = '<div class="col-span-3 text-gray-400 p-8 text-center">Aucune scène extraite.</div>';
                    return;
                }
                
                // Formatage selon nomenclature pipeline prod
                scenes.forEach((scene, idx) => {
                    // Respect strict de la nomenclature : E202_SQ0010-0010_Concept_v0001.jpg
                    const episode = projectData.episodeCode || 'E000'; // Ex: 'E202'
                    const sequence = 'SQ' + String(idx + 1).padStart(4, '0'); // SQ0001, SQ0002...
                    const shot = String(idx + 1).padStart(4, '0');            // 0001, 0002...
                    const task = scene.task || 'Concept';                     // Concept, Layout, Animation
                    const version = scene.version || 'v0001';                 // v0001, v0002...
                    const extension = scene.extension || '.jpg';              // .jpg par défaut
                    const filename = `${episode}_${sequence}-${shot}_${task}_${version}${extension}`;

                    // Récupération des champs structurés du JSON 
                    const imageUrl = scene.image_url || scene.image || '';
                    const title = scene.title || `${filename}`;
                    const voixOff = scene.voix_off || '';
                    const indicationPlan = scene.indication_plan || '';
                    const typePlan = scene.type_plan || ''; // PL, PR, GP, etc.
                    const description = scene.description || '';
                    
                    // Mapping du type de plan vers les options du menu déroulant
                    let typePlanValue = '';
                    if (typePlan) {
                        const typePlanMap = {
                            'PL': 'WS',   // Plan Large -> Wide Shot
                            'PR': 'MS',   // Plan Rapproché -> Medium Shot
                            'GP': 'CU',   // Gros Plan -> Close Up
                            'TGP': 'ECU', // Très Gros Plan -> Extreme Close Up
                            'PDV': 'POV'  // Point De Vue -> Point of View
                        };
                        typePlanValue = typePlanMap[typePlan] || typePlan;
                    }
                    
                    // Création de la carte scène avec statuts de production
                    const card = document.createElement('div');
                    card.className = 'scene-card bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md flex flex-col';
                    card.setAttribute('data-scene-id', idx);
                    card.setAttribute('data-scene-code', filename);
                    
                    // Construction de l'interface avec champs adaptés au workflow
                    card.innerHTML = `
                        <div class="p-2 border-b border-gray-100 bg-gray-50 text-xs text-gray-500 flex items-center justify-between">
                            <span class="font-mono text-indigo-700">${filename}</span>
                            <span class="text-xs bg-gray-200 px-2 py-0.5 rounded">Nomenclature prod</span>
                        </div>
                        <div class="relative aspect-video bg-gray-100 flex items-center justify-center">
                            ${imageUrl
                                ? `<img src="${imageUrl}" class="w-full h-full object-cover" onerror="this.style.opacity=0.3;showToast('Image introuvable: plan ${filename}','error',4000);">` 
                                : `<div class="text-center p-4"><i class="fas fa-image text-4xl text-gray-300 mb-2"></i><p class="text-sm text-gray-500">Storyboard only</p></div>`
                            }
                            <div class="absolute top-2 left-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded">${filename}</div>
                            <div class="absolute top-2 right-2 flex space-x-1">
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">Extracted</span>
                            </div>
                        </div>
                        <div class="p-4 flex-1 flex flex-col">
                            <div class="mb-2 flex items-center">
                                <div class="flex-1">
                                    <input type="text" value="${title.replace(/"/g,'&quot;')}" 
                                        class="scene-title-input font-semibold text-lg text-gray-900 bg-transparent border-b border-gray-200 focus:border-indigo-400 outline-none w-full" />
                                    <div class="flex items-center text-xs text-gray-500 mt-1">
                                        <select class="shot-type-select mr-2 py-1 px-2 border rounded text-xs">
                                            <option value="" ${!typePlanValue ? 'selected' : ''}>Type de plan</option>
                                            <option value="WS" ${typePlanValue === 'WS' ? 'selected' : ''}>Plan large (WS)</option>
                                            <option value="MS" ${typePlanValue === 'MS' ? 'selected' : ''}>Plan moyen (MS)</option>
                                            <option value="CU" ${typePlanValue === 'CU' ? 'selected' : ''}>Gros plan (CU)</option>
                                            <option value="ECU" ${typePlanValue === 'ECU' ? 'selected' : ''}>Très gros plan (ECU)</option>
                                            <option value="POV" ${typePlanValue === 'POV' ? 'selected' : ''}>Point de vue (POV)</option>
                                        </select>
                                        <div class="flex-1 flex justify-end">
                                            <i class="fas fa-save text-gray-300 hover:text-gray-600 cursor-pointer ml-1 save-scene-btn" title="Enregistrer"></i>
                                            <i class="fas fa-cog text-gray-300 hover:text-gray-600 cursor-pointer ml-2 scene-options-btn" title="Options avancées"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Voix off (mise en évidence) -->
                        ${voixOff ? `
                        <div class="mb-3">
                            <label class="text-xs font-bold text-indigo-700 mb-1 flex items-center">
                                <span>VOIX OFF</span>
                                <i class="fas fa-microphone text-indigo-500 ml-2 text-xs"></i>
                            </label>
                            <div class="text-sm font-medium text-gray-900 bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded">${voixOff}</div>
                        </div>` : ''}
                            
                        <!-- Indication plan (surlignée) -->
                        ${indicationPlan ? `
                        <div class="mb-3">
                            <div class="text-sm inline-block bg-amber-100 text-amber-800 px-2 py-1 rounded-lg font-medium">${indicationPlan}</div>
                        </div>` : ''}
                        
                        <!-- Description -->
                        <div class="mb-2">
                            <label class="text-xs text-gray-500 mb-1 flex items-center">
                                <span>Description</span>
                                <i class="fas fa-pen text-gray-400 ml-2 text-xs"></i>
                            </label>
                            <textarea class="scene-desc-input text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded p-2 w-full resize-none" rows="2" placeholder="Description scène...">${description}</textarea>
                        </div>
                        
                        <!-- Notes -->
                        <div>
                            <label class="text-xs text-gray-500 mb-1 flex items-center">
                                <span>Notes</span>
                                    <i class="fas fa-pen text-gray-400 ml-2 text-xs"></i>
                                </label>
                                <textarea class="scene-notes-input text-sm text-indigo-700 bg-indigo-50 border border-indigo-100 rounded p-2 w-full resize-none" rows="2" placeholder="Notes additionnelles..."></textarea>
                            </div>
                            <!-- Options de génération -->
                            <div class="mt-3 flex items-center justify-between">
                                <button class="generate-concept-btn text-xs px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 flex items-center">
                                    <i class="fas fa-magic mr-1"></i> AI-Concept
                                </button>
                                <div class="text-xs text-gray-500 status-badge">Attente&nbsp;validation</div>
                            </div>
                        </div>
                    `;
                    
                    // Gestion des événements pour sauvegarde
                    const setupAutoSave = (element, field) => {
                        element.addEventListener('input', function() {
                            // Indiquer visuellement que des changements sont en cours
                            const statusBadge = card.querySelector('.status-badge');
                            if (statusBadge) statusBadge.innerHTML = '<span class="text-yellow-500">●</span>&nbsp;Modifié';
                        });
                        
                        element.addEventListener('change', function() {
                            // Mise à jour des données
                            scenes[idx][field] = element.value;
                            
                            // Déclencher sauvegarde
                            const statusBadge = card.querySelector('.status-badge');
                            if (statusBadge) statusBadge.innerHTML = '<span class="text-blue-500">●</span>&nbsp;Sauvegarde...';
                            
                            // Fonction d'autosave (à implémenter)
                            if (typeof window.autosaveProject === 'function') {
                                window.autosaveProject(scenes);
                                setTimeout(() => {
                                    if (statusBadge) statusBadge.innerHTML = '<span class="text-green-500">●</span>&nbsp;Sauvegardé';
                                }, 800);
                            } else {
                                console.log('[Front] Simulation autosave - mise à jour de:', field, 'pour scène:', sceneCode);
                                showToast(`${sceneCode}: Modifications sauvegardées`, 'success', 1500);
                                setTimeout(() => {
                                    if (statusBadge) statusBadge.innerHTML = '<span class="text-green-500">●</span>&nbsp;Sauvegardé';
                                }, 800);
                            }
                        });
                    };
                    
                    // Configuration des listeners
                    const titleInput = card.querySelector('.scene-title-input');
                    const descInput = card.querySelector('.scene-desc-input');
                    const notesInput = card.querySelector('.scene-notes-input'); // Correction: utilisation du nouveau sélecteur et champ 'notes'
                    const shotTypeSelect = card.querySelector('.shot-type-select');
                    
                    // Gestion autosave sur chaque champ
                    setupAutoSave(titleInput, 'title');
                    setupAutoSave(descInput, 'description');
                    setupAutoSave(notesInput, 'notes'); // Correction: utilisation du nouveau sélecteur et champ 'notes'
                    setupAutoSave(shotTypeSelect, 'type_plan'); // Note: might need adjustment for select value

                    // Bouton de génération AI-Concept
                    const generateBtn = card.querySelector('.generate-concept-btn');
                    if (generateBtn) {
                        generateBtn.addEventListener('click', function() {
                            // Simulation pour le moment
                            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Génération...';
                            generateBtn.disabled = true;
                            
                            showToast(`Requête de génération AI-Concept pour ${sceneCode} envoyée`, 'info');
                            console.log(`[Front] Requête génération AI-Concept: ${sceneCode}_Concept_v0001.jpg`);
                            
                            // Simulation de réponse après délai
                            setTimeout(() => {
                                generateBtn.innerHTML = '<i class="fas fa-magic mr-1"></i> AI-Concept';
                                generateBtn.disabled = false;
                                showToast(`${sceneCode}: AI-Concept prêt pour validation`, 'success');
                            }, 3000);
                        });
                    }
                    
                    // Ajout de la carte à la grille
                    grid.appendChild(card);
                });
                
                showToast(`${scenes.length} scènes affichées avec codes production`, 'success');
            };
            
            // Placeholder pour fonction autosave - à implémenter pleinement
            window.autosaveProject = function(scenes) {
                console.log('[Front] Autosave projet avec', scenes.length, 'scènes');
                // Sera implémenté pour appeler l'API d'autosave backend
                
                // Pour le moment, on sauvegarde dans localStorage
                if (window.currentProjectData) {
                    window.currentProjectData.scenes = scenes;
                    localStorage.setItem('currentProjectData', JSON.stringify(window.currentProjectData));
                    console.log('[Front] Autosave: données projet mises à jour dans localStorage');
                }
            };
            </script>
        </body>
        <!--
            Ajout de la section style/paramétrage avancé dans la sidebar et le panneau principal.
            Les IDs des éléments sont uniques pour chaque zone (sidebar et main) pour éviter les conflits.
            Les valeurs sélectionnées pourront être synchronisées via JS si besoin (future évolution MCP).
            Tous les ajouts sont commentés pour faciliter la maintenance.
        -->
        </html>