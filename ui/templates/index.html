<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyboard-to-Video AI Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .header {
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e5e5;
        }
        .preview-container {
            margin-top: 2rem;
            text-align: center;
        }
        .preview-container video {
            max-width: 100%;
            max-height: 500px;
            margin: 0 auto;
        }
        .progress-container {
            margin-top: 2rem;
        }
        .scene-preview {
            display: flex;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: white;
        }
        .scene-preview img {
            max-width: 200px;
            max-height: 150px;
            margin-right: 1rem;
        }
        .scene-info {
            flex-grow: 1;
        }
        .style-card {
            cursor: pointer;
            transition: transform 0.2s;
            height: 100%;
        }
        .style-card:hover {
            transform: translateY(-5px);
        }
        .style-card.selected {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Storyboard-to-Video AI Platform</h1>
            <p class="lead">Convert your storyboard into a stylized animated video</p>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Upload Storyboard</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="storyboardFile" class="form-label">Select PDF or Image Folder</label>
                                <input class="form-control" type="file" id="storyboardFile" name="storyboard" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        <div id="uploadStatus" class="mt-3"></div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Select Style</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="styleContainer">
                            <!-- Styles will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Generation Options</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useCloudSwitch">
                            <label class="form-check-label" for="useCloudSwitch">Use Cloud Resources</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="useAnimationSwitch">
                            <label class="form-check-label" for="useAnimationSwitch">Use Animation Effects</label>
                        </div>
                        <button id="generateBtn" class="btn btn-success w-100" disabled>Generate Video</button>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="progress-container">
                    <h4>Generation Progress</h4>
                    <div class="progress" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
                    </div>
                    <p id="statusMessage" class="mt-2">Ready to start generation</p>
                </div>

                <div id="scenesContainer" class="mt-4">
                    <h4>Scenes</h4>
                    <div id="scenesList">
                        <!-- Scenes will be displayed here -->
                    </div>
                </div>

                <div class="preview-container">
                    <h4>Video Preview</h4>
                    <div id="videoPreview">
                        <p>Video will appear here after generation</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let uploadedStoryboardPath = null;
        let selectedStyle = 'default';
        let useCloud = false;
        let useAnimation = false;
        let isGenerating = false;
        let statusCheckInterval = null;

        // DOM elements
        const uploadForm = document.getElementById('uploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const styleContainer = document.getElementById('styleContainer');
        const useCloudSwitch = document.getElementById('useCloudSwitch');
        const useAnimationSwitch = document.getElementById('useAnimationSwitch');
        const generateBtn = document.getElementById('generateBtn');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const scenesList = document.getElementById('scenesList');
        const videoPreview = document.getElementById('videoPreview');

        // Load available styles
        function loadStyles() {
            fetch('/styles')
                .then(response => response.json())
                .then(styles => {
                    styleContainer.innerHTML = '';
                    styles.forEach(style => {
                        const styleCard = document.createElement('div');
                        styleCard.className = 'col-md-6 mb-3';
                        styleCard.innerHTML = `
                            <div class="card style-card ${style.name === selectedStyle ? 'selected' : ''}" data-style="${style.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${style.name}</h5>
                                    <p class="card-text small">${style.description || 'No description'}</p>
                                </div>
                            </div>
                        `;
                        styleContainer.appendChild(styleCard);

                        // Add click event
                        styleCard.querySelector('.style-card').addEventListener('click', () => {
                            document.querySelectorAll('.style-card').forEach(card => {
                                card.classList.remove('selected');
                            });
                            styleCard.querySelector('.style-card').classList.add('selected');
                            selectedStyle = style.name;
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading styles:', error);
                });
        }

        // Handle file upload
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(uploadForm);
            uploadStatus.innerHTML = '<div class="alert alert-info">Uploading...</div>';
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedStoryboardPath = data.path;
                    uploadStatus.innerHTML = `<div class="alert alert-success">Uploaded successfully: ${data.filename}</div>`;
                    generateBtn.disabled = false;
                } else {
                    uploadStatus.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                uploadStatus.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
        });

        // Handle generation button
        generateBtn.addEventListener('click', function() {
            if (isGenerating) return;
            if (!uploadedStoryboardPath) {
                statusMessage.textContent = 'Please upload a storyboard first';
                return;
            }

            isGenerating = true;
            generateBtn.disabled = true;
            progressBar.style.width = '0%';
            statusMessage.textContent = 'Starting generation...';
            scenesList.innerHTML = '';
            videoPreview.innerHTML = '<p>Generating video...</p>';

            // Get options
            useCloud = useCloudSwitch.checked;
            useAnimation = useAnimationSwitch.checked;

            // Start generation
            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    storyboard_path: uploadedStoryboardPath,
                    style: selectedStyle,
                    use_cloud: useCloud,
                    use_animation: useAnimation
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Start checking status
                    statusCheckInterval = setInterval(checkGenerationStatus, 1000);
                } else {
                    statusMessage.textContent = `Error: ${data.error}`;
                    isGenerating = false;
                    generateBtn.disabled = false;
                }
            })
            .catch(error => {
                statusMessage.textContent = `Error: ${error.message}`;
                isGenerating = false;
                generateBtn.disabled = false;
            });
        });

        // Check generation status
        function checkGenerationStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(status => {
                    // Update progress
                    progressBar.style.width = `${status.progress}%`;
                    statusMessage.textContent = status.message;

                    // Update scenes
                    updateScenesList(status.scenes, status.current_scene);

                    // Check if completed
                    if (!status.running && status.progress === 100) {
                        clearInterval(statusCheckInterval);
                        isGenerating = false;
                        generateBtn.disabled = false;

                        // Show video preview
                        if (status.result_video) {
                            videoPreview.innerHTML = `
                                <video controls>
                                    <source src="/preview/${status.result_video}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <div class="mt-2">
                                    <a href="/preview/${status.result_video}" class="btn btn-primary" download>Download Video</a>
                                </div>
                            `;
                        }
                    }
                    // Check if error occurred
                    else if (!status.running && status.message.startsWith('Error')) {
                        clearInterval(statusCheckInterval);
                        isGenerating = false;
                        generateBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }

        // Update scenes list
        function updateScenesList(scenes, currentScene) {
            if (!scenes || scenes.length === 0) return;

            scenesList.innerHTML = '';
            scenes.forEach((scene, index) => {
                const sceneElement = document.createElement('div');
                sceneElement.className = 'scene-preview';
                
                let imageHtml = '';
                if (scene.generated_image) {
                    imageHtml = `
                        <div class="d-flex">
                            <img src="/preview/${scene.image}" alt="Original" class="me-2">
                            <img src="/preview/${scene.generated_image}" alt="Generated">
                        </div>
                    `;
                } else {
                    imageHtml = `<img src="/preview/${scene.image}" alt="Scene ${index + 1}">`;
                }

                sceneElement.innerHTML = `
                    <div class="scene-info">
                        <h5>Scene ${index + 1}${index + 1 === currentScene ? ' (Processing)' : ''}</h5>
                        <p>${scene.text || 'No text'}</p>
                        ${imageHtml}
                    </div>
                `;
                scenesList.appendChild(sceneElement);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStyles();
        });
    </script>
</body>
</html>